<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recepci√≥n de Veh√≠culos - CDA Barrancabermeja</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        /* Header */
        .header-table {
            width: 100%;
            border-collapse: collapse;
            background: linear-gradient(135deg, #0033A0 0%, #0055CC 100%);
        }

        .header-table td {
            border: none;
            padding: 20px;
            vertical-align: middle;
        }

        .logo-cell {
            width: 140px;
            text-align: center;
        }

        .logo-container {
            background: white;
            border-radius: 50%;
            padding: 15px;
            display: inline-block;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .logo-img {
            max-width: 100px;
            height: auto;
        }

        .title-cell {
            text-align: center;
        }

        .title-cell h1 {
            font-size: 22px;
            font-weight: bold;
            color: white;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .title-cell h2 {
            font-size: 15px;
            font-weight: 600;
            color: #FFD700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .code-cell {
            width: 150px;
            text-align: center;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .code-cell div {
            font-weight: bold;
            color: white;
            font-size: 12px;
            margin: 4px 0;
        }

        /* Contenido */
        .form-content {
            padding: 25px;
        }

        .section {
            margin-bottom: 25px;
            border: 2px solid #e8ecf1;
            border-radius: 15px;
            padding: 0;
            background: #ffffff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section:hover {
            box-shadow: 0 6px 25px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .section-title {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-content {
            padding: 20px;
        }

        .datos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 13px;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border: 2px solid #dfe6e9;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
            background: white;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
        }

        .turno-display {
            font-size: 28px;
            font-weight: bold;
            color: #FF6600;
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #fff5e6 0%, #ffe6cc 100%);
            border-radius: 10px;
            margin-top: 8px;
        }

        /* Autocomplete dropdown */
        .autocomplete-items {
            position: absolute;
            border: 1px solid #cfe4ff;
            border-top: none;
            z-index: 9999;
            top: calc(100% + 2px);
            left: 0;
            right: 0;
            max-height: 240px;
            overflow-y: auto;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 8px 24px rgba(15,50,100,0.12);
        }

        .autocomplete-items div {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eef6ff;
            font-size: 14px;
        }

        .autocomplete-items div:hover {
            background: #eaf6ff;
            color: #0b76d6;
            font-weight: 700;
        }

        .autocomplete-active {
            background: #0b76d6 !important;
            color: #fff !important;
        }

        /* Radio buttons */
        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .radio-item:hover {
            background: #e8f4f8;
            border-color: #3498db;
        }

        .radio-item input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #3498db;
        }

        .radio-item label {
            font-size: 14px;
            cursor: pointer;
            margin: 0;
        }

        /* Checkboxes */
        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: white;
            border-radius: 10px;
            border: 2px solid #ecf0f1;
            transition: all 0.3s;
            cursor: pointer;
        }

        .checkbox-item:hover {
            border-color: #3498db;
            background: #f0f8ff;
            transform: translateX(3px);
        }

        .checkbox-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            accent-color: #3498db;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 13px;
            color: #2c3e50;
            flex: 1;
        }

        /* Tabla de inspecci√≥n */
        .tabla-inspeccion {
            width: 100%;
            border-collapse: collapse;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tabla-inspeccion th {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            color: white;
            padding: 15px 10px;
            font-size: 13px;
            font-weight: bold;
        }

        .tabla-inspeccion td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 13px;
        }

        .tabla-inspeccion tr:hover {
            background: #f8f9fa;
        }

        .tabla-inspeccion td.radio-cell {
            text-align: center;
            width: 70px;
            background: #f8f9fa;
        }

        .tabla-inspeccion input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #27ae60;
        }

        /* Tabla de presiones de neum√°ticos */
        .presiones-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .presiones-table th {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 12px;
            font-size: 13px;
            font-weight: bold;
            border: 1px solid #2980b9;
        }

        .presiones-table td {
            padding: 10px;
            border: 1px solid #dfe6e9;
            text-align: center;
        }

        .presiones-table td.label-cell {
            background: #f8f9fa;
            font-weight: 600;
            text-align: left;
            color: #2c3e50;
        }

        .presiones-table input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        .presiones-table input[type="number"]:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
        }

        .presiones-table input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #e74c3c;
        }

        /* Secci√≥n oculta */
        .hidden {
            display: none !important;
        }

        /* Condiciones */
        .condiciones-section {
            background: linear-gradient(135deg, #E8F4F8 0%, #D6EAF8 100%);
            border: none;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .condiciones-titulo {
            background: linear-gradient(135deg, #3A9AD9 0%, #2E86C1 100%);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 15px;
            margin: -25px -25px 20px -25px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 15px 15px 0 0;
        }

        .condiciones-alerta {
            background: linear-gradient(135deg, #FFF8DC 0%, #FFEAA7 100%);
            border: 2px solid #FFD700;
            padding: 18px;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.2);
        }

        .condiciones-alerta h3 {
            color: #856404;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-condicion {
            background: white;
            border: 2px solid #ddd;
            padding: 15px;
            margin: 12px 0;
            border-radius: 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .checkbox-condicion:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .checkbox-condicion.obligatoria {
            border-color: #FFD700;
            background: linear-gradient(135deg, #FFFEF0 0%, #FFFACD 100%);
        }

        .checkbox-condicion.opcional {
            border-color: #3498db;
            background: linear-gradient(135deg, #F0F8FF 0%, #E6F2FF 100%);
        }

        .checkbox-condicion input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-top: 2px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: #27ae60;
        }

        .checkbox-condicion label {
            font-size: 13px;
            line-height: 1.6;
            cursor: pointer;
            flex: 1;
        }

        .checkbox-condicion label strong {
            color: #0033A0;
            font-size: 14px;
        }

        .nota-adicional {
            background: linear-gradient(135deg, #D6EAF8 0%, #AED6F1 100%);
            border-left: 5px solid #3A9AD9;
            padding: 15px;
            margin-top: 20px;
            font-size: 12px;
            line-height: 1.7;
            color: #1a5490;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Firma */
        .firma-container {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border: 3px dashed #3A9AD9;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .firma-label {
            font-weight: bold;
            color: #0033A0;
            margin-bottom: 15px;
            display: block;
            font-size: 15px;
            text-align: center;
        }

        #signature-pad {
            border: 3px solid #3498db;
            border-radius: 12px;
            cursor: crosshair;
            width: 100%;
            height: 200px;
            background: #fafafa;
            touch-action: none;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        }

        .firma-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Botones */
        .btn {
            padding: 14px 35px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-limpiar {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-guardar {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-pdf {
            background: linear-gradient(135deg, #FF6600 0%, #E55A00 100%);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        /* Alertas */
        .alert {
            padding: 18px 20px;
            margin: 20px 0;
            border-radius: 12px;
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 5px solid #c0392b;
        }

        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 5px solid #27ae60;
        }

        .alert.show {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                border-radius: 10px;
            }

            .form-content {
                padding: 15px;
            }

            .header-table td {
                padding: 10px;
            }

            .logo-cell {
                width: 80px;
            }

            .logo-img {
                max-width: 60px;
            }

            .title-cell h1 {
                font-size: 16px;
            }

            .title-cell h2 {
                font-size: 12px;
            }

            .code-cell {
                width: 90px;
            }

            .code-cell div {
                font-size: 10px;
            }

            .datos-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .checkbox-grid {
                grid-template-columns: 1fr;
            }

            .radio-group {
                flex-direction: column;
                gap: 10px;
            }

            .radio-item {
                width: 100%;
            }

            .tabla-inspeccion th,
            .tabla-inspeccion td {
                padding: 10px 8px;
                font-size: 12px;
            }

            .presiones-table {
                font-size: 12px;
            }

            .presiones-table input[type="number"] {
                width: 70px;
                padding: 6px;
            }

            .section-content {
                padding: 15px;
            }

            .condiciones-section {
                padding: 15px;
            }

            .condiciones-titulo {
                margin: -15px -15px 15px -15px;
                padding: 12px 15px;
                font-size: 13px;
            }

            #signature-pad {
                height: 150px;
            }

            .btn {
                width: 100%;
                padding: 15px 20px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .turno-display {
                font-size: 24px;
            }
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
            }

            .btn, .firma-buttons, .action-buttons {
                display: none !important;
            }

            .section {
                break-inside: avoid;
            }

            @page {
                size: legal;
                margin: 1.5cm;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="printable-area">
        <!-- Header -->
        <table class="header-table">
            <tr>
                <td class="logo-cell">
                    <div class="logo-container">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImdyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiMwMDMzQTA7c3RvcC1vcGFjaXR5OjEiIC8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojMDA1NUNDO3N0b3Atb3BhY2l0eToxIiAvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjQ1IiBmaWxsPSJ1cmwoI2dyYWQpIi8+PHRleHQgeD0iNTAlIiB5PSI0MCUiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtd2VpZ2h0PSJib2xkIj5DREE8L3RleHQ+PHRleHQgeD0iNTAlIiB5PSI2NSUiIGZvbnQtc2l6ZT0iOCIgZmlsbD0iI0ZGRDcwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXdlaWdodD0iYm9sZCI+QkFSUkFOQ0FCRVJNRU9BPC90ZXh0Pjwvc3ZnPg==" alt="Logo CDA" class="logo-img">
                    </div>
                </td>
                <td class="title-cell">
                    <h1>CDA BARRANCABERMEJA</h1>
                    <h2>RECEPCI√ìN DE VEH√çCULOS LIVIANOS Y MOTOCICLETAS</h2>
                </td>
                <td class="code-cell">
                    <div>CDABR-GST-F-04</div>
                    <div>VER 14</div>
                    <div>2024-04-01</div>
                </td>
            </tr>
        </table>

        <div class="form-content">
            <!-- Alerta -->
            <div id="alert-container"></div>

            <!-- Secci√≥n 1: Datos B√°sicos -->
            <div class="section">
                <div class="section-title">üìã DATOS B√ÅSICOS DE RECEPCI√ìN</div>
                <div class="section-content">
                    <div class="datos-grid">
                        <div class="form-group">
                            <label>Fecha *</label>
                            <input type="date" id="fecha" required>
                        </div>
                        <div class="form-group">
                            <label>Hora *</label>
                            <input type="time" id="hora" required>
                        </div>
                        <div class="form-group">
                            <label>Placa *</label>
                            <input type="text" id="placa" placeholder="ABC123" required style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label>Turno</label>
                            <div class="turno-display" id="turno-display">18 18-1</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Visita *</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="visita1" name="visita" value="1" checked onchange="togglePruebasMecanizadas()">
                                <label for="visita1">Primera Vez (1¬™ Visita)</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="visita2" name="visita" value="2" onchange="togglePruebasMecanizadas()">
                                <label for="visita2">Segunda Vez (2¬™ Visita)</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Veh√≠culo Preparado *</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="prep-si" name="preparado" value="si" checked>
                                <label for="prep-si">‚úÖ S√≠</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="prep-no" name="preparado" value="no">
                                <label for="prep-no">‚ùå No</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n 2: Datos del Veh√≠culo -->
            <div class="section">
                <div class="section-title">üöô DATOS DEL VEH√çCULO</div>
                <div class="section-content">
                    <div class="datos-grid">
                        <div class="form-group">
                            <label>Marca</label>
                            <input type="text" id="marca" placeholder="Empiece a digitar..." autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Color</label>
                            <input type="text" id="color" placeholder="Empiece a digitar..." autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>N√∫mero de Sillas</label>
                            <input type="number" id="num-sillas" placeholder="5" min="1">
                        </div>
                    </div>

                    <div class="datos-grid">
                        <div class="form-group">
                            <label>Clase de Veh√≠culo *</label>
                            <select id="clase-vehiculo" required onchange="updateDynamicFields()">
                                <option value="">Seleccione...</option>
                                <option value="auto">üöó Autom√≥vil</option>
                                <option value="camioneta">üöô Camioneta</option>
                                <option value="campero">üöê Campero</option>
                                <option value="moto">üèçÔ∏è Motocicleta</option>
                                <option value="otro">üöõ Otro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Tipo de Servicio *</label>
                            <select id="tipo-servicio" required>
                                <option value="">Seleccione...</option>
                                <option value="particular">Particular</option>
                                <option value="oficial">Oficial</option>
                                <option value="publico">P√∫blico</option>
                                <option value="diplomatico">Diplom√°tico</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Tipo de Combustible *</label>
                            <select id="tipo-combustible" required onchange="toggleCertificadoGNV()">
                                <option value="">Seleccione...</option>
                                <option value="gasolina">‚õΩ Gasolina</option>
                                <option value="gas-gasolina">üî• Gas-Gasolina (GNV)</option>
                                <option value="diesel">üõ¢Ô∏è Diesel</option>
                                <option value="electrico">‚ö° El√©ctrico</option>
                                <option value="hibrido">üîã H√≠brido</option>
                                <option value="otro">Otro</option>
                            </select>
                        </div>
                    </div>

                    <!-- Campos de GNV (ocultos por defecto) -->
                    <div id="certificado-gnv-section" class="hidden" style="margin-top: 15px;">
                        <div class="datos-grid">
                            <div class="form-group">
                                <label>Certificado GNV N¬∞ *</label>
                                <input type="text" id="cert-gnv" placeholder="N√∫mero de certificado">
                            </div>
                            <div class="form-group">
                                <label>Fecha de Vigencia del Certificado *</label>
                                <input type="date" id="fecha-vigencia-gnv">
                            </div>
                        </div>
                    </div>

                    <div class="datos-grid" style="margin-top: 15px;">
                        <div class="form-group">
                            <label>Tipo de Carrocer√≠a</label>
                            <input type="text" id="carroceria" placeholder="Empiece a digitar..." autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Blindaje</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="blindaje-si" name="blindaje" value="si">
                                    <label for="blindaje-si">S√≠</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="blindaje-no" name="blindaje" value="no" checked>
                                    <label for="blindaje-no">No</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Tracci√≥n 4x4</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="traccion-si" name="traccion" value="si">
                                    <label for="traccion-si">S√≠</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="traccion-no" name="traccion" value="no" checked>
                                    <label for="traccion-no">No</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n 3: Pruebas Mecanizadas (solo 2¬™ visita) -->
            <div class="section hidden" id="pruebas-section">
                <div class="section-title">üîß PRUEBAS MECANIZADAS A REALIZAR</div>
                <div class="section-content">
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="prueba-alineacion">
                            <label for="prueba-alineacion">üìê Alineaci√≥n</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prueba-frenos">
                            <label for="prueba-frenos">üõë Frenos</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prueba-gases">
                            <label for="prueba-gases">üí® Emisi√≥n de Gases</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prueba-suspension">
                            <label for="prueba-suspension">üî© Suspensi√≥n</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prueba-luces">
                            <label for="prueba-luces">üí° Luces</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="prueba-opacidad">
                            <label for="prueba-opacidad">üå´Ô∏è Opacidad</label>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 20px;">
                        <label>Veh√≠culo P√∫blico Cumple</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="cumple-si" name="cumple" value="si">
                                <label for="cumple-si">‚úÖ S√≠</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="cumple-no" name="cumple" value="no" checked>
                                <label for="cumple-no">‚ùå No</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="cumple-na" name="cumple" value="na">
                                <label for="cumple-na">‚ûñ N/A</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secci√≥n 4: Preparaci√≥n de la Muestra (Din√°mico) -->
            <div class="section">
                <div class="section-title">üëÅÔ∏è PREPARACI√ìN DE LA MUESTRA PARA SER INSPECCIONADO</div>
                <div class="section-content">
                    <table class="tabla-inspeccion" id="tabla-inspeccion">
                        <!-- Se llenar√° din√°micamente -->
                    </table>
                </div>
            </div>

            <!-- Secci√≥n 5: Presi√≥n de Neum√°ticos -->
            <div class="section">
                <div class="section-title">üîß PRESI√ìN DE INFLADO DE NEUM√ÅTICOS</div>
                <div class="section-content">
                    <table class="presiones-table">
                        <thead>
                            <tr>
                                <th>Posici√≥n</th>
                                <th>Presi√≥n Inicial (PSI)</th>
                                <th>Presi√≥n Ajustada (PSI)</th>
                                <th>N/A</th>
                            </tr>
                        </thead>
                        <tbody id="presiones-tbody">
                            <tr>
                                <td class="label-cell">üîµ DI - Delantera Izquierda</td>
                                <td><input type="number" id="presion-di-inicial" step="0.5" placeholder="32" min="0"></td>
                                <td><input type="number" id="presion-di-ajustada" step="0.5" placeholder="32" min="0"></td>
                                <td><input type="checkbox" id="na-di" onchange="togglePresion('di')"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">üîµ DD - Delantera Derecha</td>
                                <td><input type="number" id="presion-dd-inicial" step="0.5" placeholder="32" min="0"></td>
                                <td><input type="number" id="presion-dd-ajustada" step="0.5" placeholder="32" min="0"></td>
                                <td><input type="checkbox" id="na-dd" onchange="togglePresion('dd')"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">üî¥ TI - Trasera Izquierda</td>
                                <td><input type="number" id="presion-ti-inicial" step="0.5" placeholder="32" min="0"></td>
                                <td><input type="number" id="presion-ti-ajustada" step="0.5" placeholder="32" min="0"></td>
                                <td><input type="checkbox" id="na-ti" onchange="togglePresion('ti')"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">üî¥ TD - Trasera Derecha</td>
                                <td><input type="number" id="presion-td-inicial" step="0.5" placeholder="32" min="0"></td>
                                <td><input type="number" id="presion-td-ajustada" step="0.5" placeholder="32" min="0"></td>
                                <td><input type="checkbox" id="na-td" onchange="togglePresion('td')"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">‚ö™ R - Repuesto</td>
                                <td><input type="number" id="presion-r-inicial" step="0.5" placeholder="32" min="0"></td>
                                <td><input type="number" id="presion-r-ajustada" step="0.5" placeholder="32" min="0"></td>
                                <td><input type="checkbox" id="na-r" onchange="togglePresion('r')"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- C√≥digo de Alarma -->
            <div class="section">
                <div class="section-title">üîê C√ìDIGO DE ALARMA</div>
                <div class="section-content">
                    <div class="form-group">
                        <label>C√≥digo de Desactivaci√≥n de Alarma</label>
                        <input type="text" id="codigo-alarma" placeholder="Si su veh√≠culo tiene alarma, ingrese el c√≥digo de desactivaci√≥n">
                    </div>
                </div>
            </div>

            <!-- Secci√≥n 6: Condiciones y Firma -->
            <div class="condiciones-section">
                <div class="condiciones-titulo">
                    ‚úçÔ∏è ACEPTACI√ìN DE CONDICIONES Y FIRMA
                </div>

                <div class="condiciones-alerta">
                    <h3>‚ö†Ô∏è CONDICIONES IMPORTANTES - Seleccione las que aplican</h3>
                </div>

                <div class="checkbox-condicion obligatoria">
                    <input type="checkbox" id="cond-obligatoria-1" class="check-obligatorio" required>
                    <label for="cond-obligatoria-1">
                        <strong>üü¢ OBLIGATORIA:</strong> Se√±or cliente (o usuario), las condiciones al ingresar del veh√≠culo se√±aladas son ciertas
                    </label>
                </div>

                <div class="checkbox-condicion obligatoria">
                    <input type="checkbox" id="cond-obligatoria-2" class="check-obligatorio" required>
                    <label for="cond-obligatoria-2">
                        <strong>üü¢ OBLIGATORIA:</strong> Se√±or cliente, acepta las condiciones en la que sali√≥ su veh√≠culo
                    </label>
                </div>

                <div class="checkbox-condicion opcional">
                    <input type="checkbox" id="cond-opcional-1" class="check-opcional">
                    <label for="cond-opcional-1">
                        <strong>üîµ OPCIONAL:</strong> Acepto que me contacten para gesti√≥n comercial, recordatorios de pr√≥ximo vencimiento
                    </label>
                </div>

                <div class="checkbox-condicion opcional">
                    <input type="checkbox" id="cond-opcional-2" class="check-opcional">
                    <label for="cond-opcional-2">
                        <strong>üîµ OPCIONAL:</strong> Acepto el tratamiento de mis datos personales seg√∫n pol√≠tica de privacidad
                    </label>
                </div>

                <div class="nota-adicional">
                    <strong>üìå Nota adicional:</strong> El Se√±or Recepcionista deber√° registrar las presiones de las llantas del veh√≠culo y el estado en que ingresa usando las convenciones indicadas. Si su veh√≠culo automotor cuenta con sistema de seguridad, por favor desact√≠velo.
                </div>

                <div class="firma-container">
                    <label class="firma-label">Firma del Cliente (use dedo o mouse)</label>
                    <canvas id="signature-pad"></canvas>
                    <div class="firma-buttons">
                        <button class="btn btn-limpiar" onclick="clearSignature()">üóëÔ∏è Limpiar Firma</button>
                    </div>
                </div>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="action-buttons">
                <button class="btn btn-guardar" onclick="saveRecord()">üíæ Guardar Registro</button>
                <button class="btn btn-pdf" onclick="generatePDF()">üìÑ Exportar a PDF (Oficio)</button>
            </div>
        </div>
    </div>

    <script>
        // CSV data arrays
        let marcasData = [], coloresData = [], carroceriasData = [];

        // Raw URLs (repo: cdabca/controldeingreso main branch)
        const RAW_BASE = 'https://raw.githubusercontent.com/cdabca/controldeingreso/main/';
        const URLS = {
            marcas: RAW_BASE + 'marca.csv',
            colores: RAW_BASE + 'color.csv',
            carrocerias: RAW_BASE + 'carroceria.csv'
        };

        // Items de inspecci√≥n seg√∫n tipo de veh√≠culo
        const itemsInspeccionVehiculo = [
            { texto: "Veh√≠culo descargado (vac√≠o)", defecto: "si" },
            { texto: "Veh√≠culo limpio", defecto: "si" },
            { texto: "Veh√≠culo sin tapas o copas", defecto: "si" },
            { texto: "Alarma desactivada", defecto: "si" },
            { texto: "Licencia de tr√°nsito del veh√≠culo", defecto: "si" },
            { texto: "Certificado de gas natural vigente (veh√≠culos convertidos)", defecto: "no" },
            { texto: "Llanta de repuesto visible", defecto: "si" },
            { texto: "Correcta presi√≥n de los neum√°ticos", defecto: "si" },
            { texto: "Correcto funcionamiento de al menos una luz del veh√≠culo", defecto: "si" },
            { texto: "Veh√≠culo sin candado o carpa suelta (Si Aplica)", defecto: "si" },
            { texto: "Veh√≠culo Bicombustible operando a gasolina (Si aplica)", defecto: "no" },
            { texto: "Veh√≠culo en modo inspecci√≥n (Si aplica, h√≠bridos)", defecto: "no" }
        ];

        const itemsInspeccionMoto = [
            { texto: "Motocicleta limpia", defecto: "si" },
            { texto: "Alarma desactivada", defecto: "si" },
            { texto: "Licencia de tr√°nsito del veh√≠culo", defecto: "si" },
            { texto: "Correcta presi√≥n de los neum√°ticos", defecto: "si" },
            { texto: "Correcto funcionamiento de las luces", defecto: "si" },
            { texto: "Indicador de nivel de l√≠quido de frenos visible (Si Aplica)", defecto: "no" },
            { texto: "Motocicleta de transmisi√≥n autom√°tica con soporte central", defecto: "no" },
            { texto: "Motocicleta con porta casco o maletero vac√≠o (si aplica)", defecto: "no" },
            { texto: "Espejos retrovisores en buen estado", defecto: "si" }
        ];

        // ---------- CSV loader and robust parser ----------
        async function cargarDatosCSV() {
            const statusContainer = document.getElementById('alert-container');
            // show temporary status
            statusContainer.innerHTML = '<div class="alert alert-info show">Cargando datos de autocompletado... (si prueba local use servidor)</div>';

            try {
                const [rMar, rCol, rCar] = await Promise.all([
                    fetch(URLS.marcas),
                    fetch(URLS.colores),
                    fetch(URLS.carrocerias)
                ]);

                if (!rMar.ok || !rCol.ok || !rCar.ok) {
                    const msg = `Error cargando CSV: ${rMar.status} ${rCol.status} ${rCar.status}`;
                    statusContainer.innerHTML = `<div class="alert alert-error show">‚ùå ${msg}</div>`;
                    console.error(msg);
                    return;
                }

                const [tMar, tCol, tCar] = await Promise.all([rMar.text(), rCol.text(), rCar.text()]);

                marcasData = robustParseCSV(tMar);
                coloresData = robustParseCSV(tCol);
                carroceriasData = robustParseCSV(tCar);

                statusContainer.innerHTML = `<div class="alert alert-success show">‚úÖ Autocompletado cargado (marcas: ${marcasData.length}, colores: ${coloresData.length}, carrocer√≠as: ${carroceriasData.length})</div>`;
                console.log('CSV cargados:', {marcas: marcasData.length, colores: coloresData.length, carrocerias: carroceriasData.length});
            } catch (err) {
                console.error('Error cargarDatosCSV', err);
                statusContainer.innerHTML = `<div class="alert alert-error show">‚ùå Error al cargar CSV: ${err.message || err}</div>`;
            } finally {
                setTimeout(()=>{ // hide after a bit
                    document.getElementById('alert-container').innerHTML = '';
                }, 3000);
            }
        }

        function robustParseCSV(texto) {
            if (!texto) return [];
            // normalize newlines and remove BOMs
            texto = texto.replace(/^\uFEFF/, '').replace(/^\ufeff/, '').replace(/\r/g, '\n');
            const lines = texto.split('\n').map(l => l.replace(/\uFEFF/g, '').trim()).filter(Boolean);
            const results = [];

            for (let line of lines) {
                // remove invisible unicode markers
                line = line.replace(/[\u200B-\u200F\uFEFF]/g, '').trim();
                if (!line) continue;

                // Remove leading numeric index + delimiter (e.g., "1|" or "1| " or "1;")
                line = line.replace(/^\s*\d+\s*[\|\;\,]\s*/, '');
                // If still contains a leading numeric and space, remove "1 "
                line = line.replace(/^\s*\d+\s+/, '');

                // If there's a pipe, take everything after first pipe (common format in provided CSVs)
                if (line.includes('|')) {
                    const afterPipe = line.split('|').slice(1).join('|').trim();
                    if (afterPipe) line = afterPipe;
                }

                // If multiple columns separated by ; or , take first meaningful column
                if (line.includes(';')) line = line.split(';')[0];
                else if (line.includes(',')) line = line.split(',')[0];

                // Trim quotes and stray semicolons
                let valor = line.replace(/^"+|"+$/g, '').replace(/;+$/g,'').trim();
                valor = valor.replace(/[\u200B-\u200F\uFEFF]/g, '').trim();

                if (!valor) continue;

                // Ignore header words
                const up = valor.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                if (['MARCA','COLOR','CARROCERIA','CARROCER√çA','CARROCERIA'].includes(up)) continue;

                results.push(valor);
            }

            // Unique and stable sorting (locale aware)
            const uniq = Array.from(new Set(results.map(s => s.trim()).filter(Boolean)));
            return uniq.sort((a,b) => a.localeCompare(b, 'es', {sensitivity:'base'}));
        }

        // ---------- Autocomplete ----------
        function setupAutocomplete(inputEl, sourceArray, maxResults = 80) {
            if (!inputEl) return;
            inputEl.addEventListener('input', function() {
                closeAllLists();
                const val = this.value;
                if (!val) return;
                const container = document.createElement('div');
                container.setAttribute('class','autocomplete-items');
                this.parentNode.appendChild(container);

                const q = val.trim().toUpperCase();
                if (!q) return;

                // prioritize startsWith then includes
                const starts = [], contains = [];
                for (const item of sourceArray) {
                    const u = item.toUpperCase();
                    if (u.startsWith(q)) starts.push(item);
                    else if (u.includes(q)) contains.push(item);
                    if (starts.length + contains.length >= maxResults) break;
                }
                const matches = starts.concat(contains).slice(0, maxResults);
                if (!matches.length) {
                    const no = document.createElement('div'); no.textContent = 'Sin resultados';
                    container.appendChild(no);
                    return;
                }
                matches.forEach(m => {
                    const div = document.createElement('div');
                    const idx = m.toUpperCase().indexOf(q);
                    if (idx >= 0) {
                        div.innerHTML = m.substr(0,idx) + '<strong>' + m.substr(idx, q.length) + '</strong>' + m.substr(idx + q.length);
                    } else div.textContent = m;
                    const hidden = document.createElement('input'); hidden.type = 'hidden'; hidden.value = m;
                    div.appendChild(hidden);
                    div.addEventListener('click', function() {
                        inputEl.value = this.getElementsByTagName('input')[0].value;
                        closeAllLists();
                        inputEl.dispatchEvent(new Event('change'));
                    });
                    container.appendChild(div);
                });
            });

            inputEl.addEventListener('keydown', function(e) {
                let x = this.parentNode.querySelector('.autocomplete-items');
                if (!x) return;
                x = x.getElementsByTagName('div');
                if (!x.length) return;
                let current = -1;
                for (let i=0;i<x.length;i++) if (x[i].classList.contains('autocomplete-active')) current = i;
                if (e.key === 'ArrowDown') {
                    if (current < x.length-1) {
                        if (current >=0) x[current].classList.remove('autocomplete-active');
                        x[++current].classList.add('autocomplete-active');
                    }
                    e.preventDefault();
                } else if (e.key === 'ArrowUp') {
                    if (current > 0) {
                        x[current].classList.remove('autocomplete-active');
                        x[--current].classList.add('autocomplete-active');
                    }
                    e.preventDefault();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (current > -1) x[current].click();
                }
            });

            function closeAllLists(el) {
                const items = document.getElementsByClassName('autocomplete-items');
                for (let i=0;i<items.length;i++) {
                    if (el !== items[i] && el !== inputEl) {
                        if (items[i].parentNode) items[i].parentNode.removeChild(items[i]);
                    }
                }
            }
            document.addEventListener('click', function(e){ closeAllLists(e.target); });
        }

        // ---------- Dynamic inspection table ----------
        function updateDynamicFields() {
            const claseVehiculo = document.getElementById('clase-vehiculo').value;
            const tabla = document.getElementById('tabla-inspeccion');

            if (!claseVehiculo) {
                tabla.innerHTML = '<tr><td style="text-align: center; padding: 20px; color: #999;">Seleccione una clase de veh√≠culo para mostrar la lista de preparaci√≥n</td></tr>';
                return;
            }

            const items = (claseVehiculo === 'moto') ? itemsInspeccionMoto : itemsInspeccionVehiculo;

            let html = `
                <thead>
                    <tr>
                        <th style="text-align: left;">Descripci√≥n</th>
                        <th style="width: 70px;">S√≠</th>
                        <th style="width: 70px;">No</th>
                    </tr>
                </thead>
                <tbody>
            `;

            items.forEach((item, index) => {
                const checkedSi = item.defecto === 'si' ? 'checked' : '';
                const checkedNo = item.defecto === 'no' ? 'checked' : '';

                html += `
                    <tr>
                        <td>${item.texto}</td>
                        <td class="radio-cell"><input type="radio" name="insp-${index}" value="si" ${checkedSi}></td>
                        <td class="radio-cell"><input type="radio" name="insp-${index}" value="no" ${checkedNo}></td>
                    </tr>
                `;
            });

            html += '</tbody>';
            tabla.innerHTML = html;
        }

        // ---------- Presi√≥n toggle ----------
        function togglePresion(posicion) {
            const checkbox = document.getElementById(`na-${posicion}`);
            const inputInicial = document.getElementById(`presion-${posicion}-inicial`);
            const inputAjustada = document.getElementById(`presion-${posicion}-ajustada`);

            if (checkbox.checked) {
                inputInicial.disabled = true;
                inputAjustada.disabled = true;
                inputInicial.value = '';
                inputAjustada.value = '';
                inputInicial.style.background = '#e9ecef';
                inputAjustada.style.background = '#e9ecef';
            } else {
                inputInicial.disabled = false;
                inputAjustada.disabled = false;
                inputInicial.style.background = '';
                inputAjustada.style.background = '';
            }
        }

        // ---------- Signature canvas ----------
        function setupSignaturePad() {
            const canvas = document.getElementById('signature-pad');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            // set size
            canvas.width = canvas.offsetWidth;
            canvas.height = 200;

            let drawing = false;
            let lastX = 0;
            let lastY = 0;

            function startDrawing(e) {
                drawing = true;
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches ? e.touches[0] : null;
                lastX = (touch ? touch.clientX : e.clientX) - rect.left;
                lastY = (touch ? touch.clientY : e.clientY) - rect.top;
            }

            function draw(e) {
                if (!drawing) return;
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches ? e.touches[0] : null;
                const x = (touch ? touch.clientX : e.clientX) - rect.left;
                const y = (touch ? touch.clientY : e.clientY) - rect.top;

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.stroke();

                lastX = x;
                lastY = y;
            }

            function stopDrawing() {
                drawing = false;
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function clearSignature() {
            const canvas = document.getElementById('signature-pad');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // ---------- Alerts / validation / collect / save / pdf ----------
        function showAlert(message, type) {
            const container = document.getElementById('alert-container');
            const icon = type === 'success' ? '‚úÖ' : '‚ùå';
            container.innerHTML = `<div class="alert alert-${type} show">${icon} ${message}</div>`;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        }

        function validateForm() {
            const fecha = document.getElementById('fecha').value;
            const hora = document.getElementById('hora').value;
            const placa = document.getElementById('placa').value;
            const claseVehiculo = document.getElementById('clase-vehiculo').value;
            const tipoServicio = document.getElementById('tipo-servicio').value;
            const tipoCombustible = document.getElementById('tipo-combustible').value;

            if (!fecha || !hora || !placa || !claseVehiculo || !tipoServicio || !tipoCombustible) {
                showAlert('Por favor complete todos los campos obligatorios marcados con *', 'error');
                return false;
            }

            if (tipoCombustible === 'gas-gasolina') {
                const certGnv = document.getElementById('cert-gnv').value;
                const fechaGnv = document.getElementById('fecha-vigencia-gnv').value;
                if (!certGnv || !fechaGnv) {
                    showAlert('Debe completar el Certificado GNV y su fecha de vigencia', 'error');
                    return false;
                }
            }

            const checksObligatorios = document.querySelectorAll('.check-obligatorio');
            let todosChecked = true;
            checksObligatorios.forEach(check => { if (!check.checked) todosChecked = false; });
            if (!todosChecked) {
                showAlert('Debe aceptar todas las condiciones OBLIGATORIAS marcadas con üü¢', 'error');
                return false;
            }

            const canvas = document.getElementById('signature-pad');
            if (!canvas) { showAlert('Falta canvas de firma', 'error'); return false; }
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const isEmpty = !imageData.data.some(channel => channel !== 0);
            if (isEmpty) { showAlert('Por favor firme el documento antes de guardar', 'error'); return false; }

            return true;
        }

        function collectFormData() {
            const data = {
                fecha: document.getElementById('fecha').value,
                hora: document.getElementById('hora').value,
                placa: document.getElementById('placa').value.toUpperCase(),
                visita: document.querySelector('input[name="visita"]:checked').value,
                preparado: document.querySelector('input[name="preparado"]:checked').value,
                marca: document.getElementById('marca').value,
                color: document.getElementById('color').value,
                numSillas: document.getElementById('num-sillas').value,
                claseVehiculo: document.getElementById('clase-vehiculo').value,
                tipoServicio: document.getElementById('tipo-servicio').value,
                tipoCombustible: document.getElementById('tipo-combustible').value,
                certificadoGNV: document.getElementById('cert-gnv').value,
                fechaVigenciaGNV: document.getElementById('fecha-vigencia-gnv').value,
                tipoCarroceria: (document.getElementById('carroceria') ? document.getElementById('carroceria').value : '') || (document.getElementById('tipo-carroceria') ? document.getElementById('tipo-carroceria').value : ''),
                blindaje: document.querySelector('input[name="blindaje"]:checked').value,
                traccion: document.querySelector('input[name="traccion"]:checked').value,
                codigoAlarma: document.getElementById('codigo-alarma').value,
                pruebas: [],
                inspeccion: [],
                presionesNeumaticos: {
                    DI: { inicial: document.getElementById('presion-di-inicial').value, ajustada: document.getElementById('presion-di-ajustada').value, na: document.getElementById('na-di').checked },
                    DD: { inicial: document.getElementById('presion-dd-inicial').value, ajustada: document.getElementById('presion-dd-ajustada').value, na: document.getElementById('na-dd').checked },
                    TI: { inicial: document.getElementById('presion-ti-inicial').value, ajustada: document.getElementById('presion-ti-ajustada').value, na: document.getElementById('na-ti').checked },
                    TD: { inicial: document.getElementById('presion-td-inicial').value, ajustada: document.getElementById('presion-td-ajustada').value, na: document.getElementById('na-td').checked },
                    R:  { inicial: document.getElementById('presion-r-inicial').value, ajustada: document.getElementById('presion-r-ajustada').value, na: document.getElementById('na-r').checked }
                },
                condiciones: { obligatorias: [], opcionales: [] },
                firma: (document.getElementById('signature-pad') ? document.getElementById('signature-pad').toDataURL() : ''),
                timestamp: new Date().toISOString()
            };

            if (data.visita === '2') {
                ['alineacion', 'frenos', 'gases', 'suspension', 'luces', 'opacidad'].forEach(prueba => {
                    const checkbox = document.getElementById(`prueba-${prueba}`);
                    if (checkbox && checkbox.checked) data.pruebas.push(prueba);
                });
                const cumple = document.querySelector('input[name="cumple"]:checked');
                if (cumple) data.vehiculoPublicoCumple = cumple.value;
            }

            const items = (data.claseVehiculo === 'moto') ? itemsInspeccionMoto : itemsInspeccionVehiculo;
            items.forEach((item, index) => {
                const selected = document.querySelector(`input[name="insp-${index}"]:checked`);
                if (selected) data.inspeccion.push({ descripcion: item.texto, valor: selected.value });
            });

            document.querySelectorAll('.check-obligatorio').forEach((check, index) => {
                data.condiciones.obligatorias.push({ id: index+1, checked: check.checked });
            });
            document.querySelectorAll('.check-opcional').forEach((check, index) => {
                data.condiciones.opcionales.push({ id: index+1, checked: check.checked });
            });

            return data;
        }

        function saveRecord() {
            if (!validateForm()) return;
            const data = collectFormData();
            const registros = JSON.parse(localStorage.getItem('registros-cda') || '[]');
            registros.push(data);
            localStorage.setItem('registros-cda', JSON.stringify(registros));
            showAlert('Registro guardado exitosamente en el sistema', 'success');
            console.log('Datos guardados:', data);
        }

        function generatePDF() {
            if (!validateForm()) return;
            const buttons = document.querySelectorAll('.btn, .firma-buttons');
            buttons.forEach(btn => btn.style.display = 'none');
            const element = document.getElementById('printable-area');
            html2canvas(element, { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'legal');
                const imgWidth = 215.9;
                const pageHeight = 355.6;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                const placa = document.getElementById('placa').value || 'NO_PLACA';
                const fecha = document.getElementById('fecha').value || new Date().toISOString().slice(0,10);
                pdf.save(`Recepcion_CDA_${placa}_${fecha}.pdf`);
                buttons.forEach(btn => btn.style.display = '');
                showAlert('‚úÖ PDF generado exitosamente', 'success');
            });
        }

        // Toggle pruebas mecanizadas visibility based on visita radio
        function togglePruebasMecanizadas() {
            const visita = document.querySelector('input[name="visita"]:checked').value;
            const pruebasSection = document.getElementById('pruebas-section');
            if (visita === '2') pruebasSection.classList.remove('hidden');
            else pruebasSection.classList.add('hidden');
        }

        // Toggle certificado GNV section
        function toggleCertificadoGNV() {
            const tipo = document.getElementById('tipo-combustible').value;
            const sec = document.getElementById('certificado-gnv-section');
            if (tipo === 'gas-gasolina') sec.classList.remove('hidden'); else sec.classList.add('hidden');
        }

        // ---------- Initialization: load CSVs, setup autocompletes, signature, table ----------
        document.addEventListener('DOMContentLoaded', async function() {
            const now = new Date();
            document.getElementById('fecha').valueAsDate = now;
            document.getElementById('hora').value = now.toTimeString().slice(0,5);

            // cargar CSV y luego configurar autocompletes
            await cargarDatosCSV();

            try {
                setupAutocomplete(document.getElementById('marca'), marcasData.length ? marcasData : []);
                setupAutocomplete(document.getElementById('color'), coloresData.length ? coloresData : []);
                setupAutocomplete(document.getElementById('carroceria'), carroceriasData.length ? carroceriasData : []);
            } catch (err) {
                console.warn('Error inicializando autocompletes', err);
            }

            // Ensure table is generated at start
            if (!document.getElementById('clase-vehiculo').value) document.getElementById('clase-vehiculo').value = 'auto';
            updateDynamicFields();
            setupSignaturePad();

            // also update dynamic fields when class changes (already set onchange but ensure listener)
            document.getElementById('clase-vehiculo').addEventListener('change', updateDynamicFields);

            // Convert placa to uppercase
            const placaInput = document.getElementById('placa');
            if (placaInput) placaInput.addEventListener('input', function(e) { e.target.value = e.target.value.toUpperCase(); });

            // Ensure visita change toggles pruebas section
            const visitaRadios = document.querySelectorAll('input[name="visita"]');
            visitaRadios.forEach(r => r.addEventListener('change', togglePruebasMecanizadas));
        });

    </script>
</body>
</html>
