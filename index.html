<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Recepción CDA - Autocomplete CSV (fix)</title>
  <style>
    /* (estilos reducidos para centrarnos en funcionalidad) */
    body{font-family:Arial,Helvetica,sans-serif;background:#f4f6fb;padding:12px;}
    .container{max-width:1100px;margin:0 auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
    .datos-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:12px}
    .form-group{position:relative}
    label{font-weight:600;margin-bottom:6px;display:block}
    input[type="text"],select,input[type="date"],input[type="time"],input[type="number"]{width:100%;padding:10px;border:1px solid #d7e0ee;border-radius:8px;background:#fbfdff}
    .autocomplete-items{position:absolute;left:0;right:0;top:100%;z-index:99;border:1px solid #cfe4ff;background:#fff;max-height:240px;overflow:auto;border-radius:0 0 8px 8px;box-shadow:0 8px 20px rgba(15,50,100,.08)}
    .autocomplete-items div{padding:8px 10px;cursor:pointer;border-bottom:1px solid #eef6ff}
    .autocomplete-items div:hover{background:#eef9ff;color:#0b76d6;font-weight:600}
    .hidden{display:none!important}
    .loading{width:14px;height:14px;border:3px solid #cfe4ff;border-top-color:#0b76d6;border-radius:50%;animation:spin .85s linear infinite;display:inline-block;vertical-align:middle;margin-left:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .tabla-inspeccion{width:100%;border-collapse:collapse;margin-top:8px}
    .tabla-inspeccion th{background:#0b76d6;color:#fff;padding:8px;text-align:left}
    .tabla-inspeccion td{padding:8px;border-bottom:1px solid #eef6ff}
    .alert{padding:10px;border-radius:8px;margin-bottom:12px}
    .alert-error{background:#fdecea;color:#722}
    .alert-info{background:#eef9ff;color:#065}
  </style>
</head>
<body>
  <div class="container">
    <h2>Recepción - CDA BARRANCABERMEJA</h2>

    <div id="status" class="alert alert-info">Cargando datos de autocompletado<span id="loader" class="loading"></span></div>

    <div class="section">
      <div class="section-title">Datos básicos</div>
      <div class="section-content">
        <div class="datos-grid">
          <div class="form-group">
            <label>Fecha</label>
            <input id="fecha" type="date">
          </div>
          <div class="form-group">
            <label>Hora</label>
            <input id="hora" type="time">
          </div>
          <div class="form-group">
            <label>Placa</label>
            <input id="placa" type="text" style="text-transform:uppercase">
          </div>
          <div class="form-group">
            <label>Turno</label>
            <input id="turno" type="text" value="18 18-1">
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Datos del vehículo</div>
      <div class="section-content">
        <div class="datos-grid">
          <div class="form-group">
            <label>Marca</label>
            <input id="marca" type="text" placeholder="Empiece a digitar..." autocomplete="off">
            <!-- autocomplete container se inyecta aquí -->
          </div>

          <div class="form-group">
            <label>Color</label>
            <input id="color" type="text" placeholder="Empiece a digitar..." autocomplete="off">
          </div>

          <div class="form-group">
            <label>Carrocería</label>
            <input id="carroceria" type="text" placeholder="Empiece a digitar..." autocomplete="off">
          </div>

          <div class="form-group">
            <label>Clase de vehículo</label>
            <select id="clase-vehiculo">
              <option value="auto">Automóvil</option>
              <option value="moto">Motocicleta</option>
              <option value="camioneta">Camioneta</option>
              <option value="otro">Otro</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Preparación de la muestra</div>
      <div id="tabla-wrapper">
        <table id="tabla-inspeccion" class="tabla-inspeccion"></table>
      </div>
    </div>

    <div style="margin-top:12px">
      <button id="btn-guardar">Guardar (prueba)</button>
    </div>

    <div style="margin-top:12px" id="debug"></div>
  </div>

<script>
/*
  Fixes aplicados:
  - parse CSV robusto (elimina BOM, maneja '|', ';' y ';' finales).
  - carga desde raw.githubusercontent (si pruebas en local, sirve con http-server o python -m http.server).
  - inicializa autocomplete y construye tabla de inspección inmediatamente.
  - añade logs y mensajes de estado visibles.
*/

let marcasData = [], coloresData = [], carroceriasData = [];

async function cargarDatosCSV() {
  const status = document.getElementById('status');
  const loader = document.getElementById('loader');
  status.className = 'alert alert-info';
  status.textContent = 'Cargando datos de autocompletado';
  loader.style.display = 'inline-block';

  try {
    // URL raw en repo (asegúrate de que el archivo exista en main)
    const urls = {
      marcas: 'https://raw.githubusercontent.com/cdabca/controldeingreso/main/marca.csv',
      colores: 'https://raw.githubusercontent.com/cdabca/controldeingreso/main/color.csv',
      carrocerias: 'https://raw.githubusercontent.com/cdabca/controldeingreso/main/carroceria.csv'
    };

    const [rMar, rCol, rCar] = await Promise.all([
      fetch(urls.marcas),
      fetch(urls.colores),
      fetch(urls.carrocerias)
    ]);

    if (!rMar.ok || !rCol.ok || !rCar.ok) {
      throw new Error('Fetch falló: ' + [rMar.status, rCol.status, rCar.status].join(','));
    }

    const [tMar, tCol, tCar] = await Promise.all([rMar.text(), rCol.text(), rCar.text()]);

    marcasData = parsearCSV(tMar);
    coloresData = parsearCSV(tCol);
    carroceriasData = parsearCSV(tCar);

    console.log('marcas count', marcasData.length);
    console.log('colores count', coloresData.length);
    console.log('carrocerias count', carroceriasData.length);

    // Actualizar status
    status.textContent = 'Datos cargados: marcas=' + marcasData.length + ' colores=' + coloresData.length + ' carrocerías=' + carroceriasData.length;
    loader.style.display = 'none';

    // Si arrays vacíos mostrar aviso
    if (!marcasData.length || !coloresData.length || !carroceriasData.length) {
      status.className = 'alert alert-error';
      status.textContent = 'ATENCIÓN: uno o más CSV se cargaron vacíos. Revisa las rutas o el contenido.';
    }
  } catch (err) {
    console.error('Error cargarDatosCSV:', err);
    document.getElementById('status').className = 'alert alert-error';
    document.getElementById('status').textContent = 'Error cargando CSV: ' + (err.message || err);
    document.getElementById('loader').style.display = 'none';
  }
}

// parse CSV robusto
function parsearCSV(texto) {
  if (!texto) return [];
  // normalize de finales CRLF
  texto = texto.replace(/\r/g, '\n');
  const lineas = texto.split('\n').map(l => l.trim()).filter(l => l.length);
  const datos = [];
  for (let i = 0; i < lineas.length; i++) {
    let linea = lineas[i];
    // eliminar BOM si existe
    linea = linea.replace(/^\uFEFF/, '').replace(/^\ufeff/, '').trim();

    // Intentar separar por '|' (formato visible en repo), si no, por ';' y si no, por coma
    let partes = linea.split('|');
    let valor = '';
    if (partes.length >= 2) {
      // tomar todo lo que sigue al primer separador '|' por si hay pipes internos
      valor = partes.slice(1).join('|').trim();
    } else {
      partes = linea.split(';');
      if (partes.length >= 2) valor = partes.slice(1).join(';').trim();
      else {
        partes = linea.split(',');
        if (partes.length >= 2) valor = partes.slice(1).join(',').trim();
        else valor = partes[0].trim();
      }
    }
    // limpiar caracteres residuales como ; al final o ;; o comillas
    valor = valor.replace(/;+$/,'').replace(/^;+/, '').trim();
    // si valor contiene campos separados por ';' al final (ej: "MARCA;;") intentar tomar primer token alfabético
    if (!valor && partes.length >= 2) {
      // fallback: tomar la segunda columna antes de cualquier ';'
      valor = partes[1] ? partes[1].split(';')[0].trim() : '';
    }
    // filtrar encabezados genéricos
    if (!valor) continue;
    const valUpper = valor.toUpperCase();
    if (valUpper === 'MARCA' || valUpper === 'COLOR' || valUpper === 'CARROCERIA' || valUpper === 'CARROCERÍA') continue;
    datos.push(valor);
  }
  // eliminar duplicados y limpiar espacios
  const uniq = Array.from(new Set(datos.map(s => s.trim()).filter(Boolean)));
  return uniq;
}

// Autocomplete genérico
function setupAutocomplete(inputEl, sourceArray) {
  inputEl.parentNode.classList.add('autocomplete');
  inputEl.addEventListener('input', function() {
    closeAllLists();
    const val = this.value;
    if (!val) return;
    const list = document.createElement('div');
    list.setAttribute('class', 'autocomplete-items');
    this.parentNode.appendChild(list);

    const q = val.toUpperCase();
    let matches = sourceArray.filter(s => s.toUpperCase().includes(q));
    // priorizar que empiece por la cadena
    matches.sort((a,b)=>{
      const ai = a.toUpperCase().indexOf(q), bi = b.toUpperCase().indexOf(q);
      return (ai === bi) ? a.localeCompare(b) : (ai - bi);
    });
    matches = matches.slice(0, 80); // límite

    if (!matches.length) {
      const none = document.createElement('div');
      none.textContent = 'Sin resultados';
      list.appendChild(none);
      return;
    }

    matches.forEach(m=>{
      const item = document.createElement('div');
      const idx = m.toUpperCase().indexOf(q);
      if (idx >= 0) {
        item.innerHTML = m.substr(0,idx) + '<strong>' + m.substr(idx, q.length) + '</strong>' + m.substr(idx + q.length);
      } else item.textContent = m;
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.value = m;
      item.appendChild(hidden);
      item.addEventListener('click', function(){
        inputEl.value = this.getElementsByTagName('input')[0].value;
        closeAllLists();
        inputEl.dispatchEvent(new Event('change'));
      });
      list.appendChild(item);
    });
  });

  inputEl.addEventListener('keydown', function(e){
    const itemsContainer = this.parentNode.querySelector('.autocomplete-items');
    if (!itemsContainer) return;
    const items = itemsContainer.getElementsByTagName('div');
    if (!items.length) return;
    const active = itemsContainer.querySelector('.autocomplete-active');
    let index = Array.prototype.indexOf.call(items, active);
    if (e.key === 'ArrowDown') {
      index = (index+1) % items.length;
      if (active) active.classList.remove('autocomplete-active');
      items[index].classList.add('autocomplete-active');
      e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      index = (index - 1 + items.length) % items.length;
      if (active) active.classList.remove('autocomplete-active');
      items[index].classList.add('autocomplete-active');
      e.preventDefault();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (index >= 0) items[index].click();
    }
  });

  function closeAllLists(el) {
    const items = document.getElementsByClassName('autocomplete-items');
    for (let i=0;i<items.length;i++) {
      if (el !== items[i] && el !== inputEl) items[i].parentNode.removeChild(items[i]);
    }
  }
  document.addEventListener('click', function(e){ closeAllLists(e.target); });
}

// Construir tabla inspección según clase
const vehItems = [
  "Vehículo descargado (vacío)",
  "Vehículo limpio",
  "Vehículo sin tapas o copas",
  "Alarma desactivada",
  "Licencia de tránsito del vehículo",
  "Certificado de gas natural vigente (vehículos convertidos)",
  "Llanta de repuesto visible",
  "Correcta presión de los neumáticos",
  "Correcto funcionamiento de al menos una luz del vehículo",
  "Vehículo sin candado o carpa suelta (Si Aplica)"
];

const motoItems = [
  "Motocicleta limpia",
  "Alarma desactivada",
  "Licencia de tránsito del vehículo",
  "Correcta presión de los neumáticos",
  "Correcto funcionamiento de las luces",
  "Indicador de nivel de líquido de frenos visible (Si Aplica)",
  "Motocicleta con porta casco o maletero vacío (si aplica)"
];

function updateDynamicFields() {
  const clase = document.getElementById('clase-vehiculo').value;
  const tabla = document.getElementById('tabla-inspeccion');
  let items = vehItems;
  if (clase === 'moto') items = motoItems;
  // construir HTML
  let html = '<thead><tr><th>Descripción</th><th style="width:80px">Sí</th><th style="width:80px">No</th></tr></thead><tbody>';
  items.forEach((it,i)=>{
    html += `<tr><td>${it}</td><td><input type="radio" name="insp-${i}" value="si"></td><td><input type="radio" name="insp-${i}" value="no"></td></tr>`;
  });
  html += '</tbody>';
  tabla.innerHTML = html;
}

// Toggle pruebas mecanizadas (ejemplo)
function togglePruebasMecanizadas() {
  // si necesitas esta lógica inclúyela
}

// Inicialización
document.addEventListener('DOMContentLoaded', async () => {
  // fecha/hora por defecto
  const now = new Date();
  document.getElementById('fecha').valueAsDate = now;
  document.getElementById('hora').value = now.toTimeString().slice(0,5);

  await cargarDatosCSV();

  // Configurar autocomplete (si arrays vacíos, pasar array de ejemplo)
  setupAutocomplete(document.getElementById('marca'), marcasData.length?marcasData:['SIN DATOS']);
  setupAutocomplete(document.getElementById('color'), coloresData.length?coloresData:['SIN DATOS']);
  setupAutocomplete(document.getElementById('carroceria'), carroceriasData.length?carroceriasData:['SIN DATOS']);

  // generar tabla inicial (usa la clase actual o 'auto' por defecto)
  if (!document.getElementById('clase-vehiculo').value) document.getElementById('clase-vehiculo').value = 'auto';
  updateDynamicFields();

  // escuchar cambio de clase
  document.getElementById('clase-vehiculo').addEventListener('change', updateDynamicFields);
});

// botón prueba guardar
document.getElementById('btn-guardar').addEventListener('click', ()=>{
  const debug = document.getElementById('debug');
  const marca = document.getElementById('marca').value;
  const color = document.getElementById('color').value;
  const carro = document.getElementById('carroceria').value;
  debug.textContent = `Guardar: Marca="${marca}" Color="${color}" Carrocería="${carro}"`;
});
</script>
</body>
</html>
